// init.js
// provide one-liner initialization of haraldops

// imports
// http://nodejs.org/docs/latest/api/fs.html
var fs = require('fs')
// http://nodejs.org/api/path.html
var path = require('path')
// http://nodejs.org/docs/latest/api/util.html
var util = require('util')

// exports
module.exports = merge(
	{
		init: init,
	},
	require('./mailsend'),
	require('./pingerlist'),
	require('./jsonloader'),
	require('./tee'),
	require('./init'),
	require('./logrequest'),
	require('./errorstack'),
	require('./ops')
)
exports = module.exports

var allowedChars = '0123456789abcdefghijklmnopqrstuvwxyz'
var ext = '.json'

// opts
// .logger: logging function, eg. console.log
// .path: string or array of strings, eg. __dirname or __filename from calling script
// .appName: A human readable application name like 'Great Web site'
// identifier is derived from appname or the last part of the first path provided
// results: defaults.init.appName, defaults.init.identifier
function init(optsArg) {

	// parse options
	var opts = {}
	if (typeof optsArg != 'object') optsArg = {}

	// determine logger
	opts.logger = typeof optsArg.logger == 'function' ? optsArg.logger : function () {}

	// assemble paths to an array of strings
	opts.paths = []
	var good = true
	if (Array.isArray(optsArg.path)) {
		good = optsArg.path.every(function (path) {
			return exports.pushString(opts.paths, path)
		})
	} else {
		if (optsArg.path) good = exports.pushString(opts.paths, optsArg.path)
	}
	if (!good) throw Error('opts.path must be string or array of strings')

	// get appName
	var name
	if (optsArg.appName) {
		name = optsArg.appName.valueOf()
		if (typeof name != 'string') throw Error('opts.appName must be string')
	}
	if (!name) {
		if (!opts.paths.length) throw Error('either opts.appName or opts.path must be provided')
		name = path.basename(opts.path[0], path.extname(opts.path[0]))
		if (!name) throw Error('appName could not be determined')
	}
	opts.appName = name

	// determine opts.identifier
	opts.identifier = createIdentifier(name)

	// read our settings from either ~/AppMarker or scriptfolder/AppMarker
	var defaults = exports.loadSettings(opts.identifier, opts.folder)

	opts.tmpFolder = exports.getTmpFolder()

	// save our data
	defaults.init = opts

	// execute configuration
	if (defaults.haraldops &&
		defaults.haraldops.logFile) {
		exports.tee(defaults.haraldops)
	}
	opts.logger(util.format('\n\n=== %s %s starting',
		getNow(),
		opts.appName))
	if (defaults.haraldops &&
		(defaults.haraldops.pingers ||
			defaults.haraldops.responder)) {
		if (!defaults.haraldops.identifier) defaults.haraldops.identifier = opts.identifier
		defaults.init.ops = exports.opsconstructor(opts.logger, defaults.haraldops)
	}
	if (defaults.haraldops && defaults.haraldops.errorstack) exports.errorstack()

	// PORT
	if (process.env.PORT) defaults.PORT = process.env.PORT
	if (!defaults.PORT) defaults.PORT = 3000

	// convert 'regex:...' to regexp
	if (Array.isArray(defaults.ignoreUris))
		defaults.ignoreUris.forEach(function (uri, index, arr) {
			if (uri.substring(0, 7) == 'regexp:') {
				arr[index] = new RegExp(uri.substring(7, uri.length).replace('/', '\\/'))
			}
		})

	return defaults

}

// appName: human readable application name string eg. 'Great App #3!!'
// return value: filesystem friendly application marker eg. 'greatapp3'
function createIdentifier(appName) {
	var result = ''
	appName = appName.toLowerCase()
	for (var index in appName) {
		var ch = appName.charAt(index)
		if (allowedChars.indexOf(ch) != -1) result += ch
	}
	if (result.length == 0) throw Error('AppMarker can not be empty string')
	return result
}

// yyyy-mm-dd hh:mm:ss local time
function getNow() {
	var myDate= new Date(Date.now() - 60000 * new Date().getTimezoneOffset()).toISOString()
	myDate = myDate.substring(0, 10) + ' ' + myDate.substring(11, 19)
	return myDate
}

// return an object with the properties of all provided objects
function merge() {
	var result = {}
	for (index in arguments) {
		var obj = arguments[index]
		for (property in obj) {
			result[property] = obj[property]
		}
	}
	return result
}
